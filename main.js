"use strict";var w=Object.defineProperty,R=Object.defineProperties,H=Object.getOwnPropertyDescriptor,I=Object.getOwnPropertyDescriptors,A=Object.getOwnPropertyNames,P=Object.getOwnPropertySymbols;var E=Object.prototype.hasOwnProperty,W=Object.prototype.propertyIsEnumerable;var D=(i,t,e)=>t in i?w(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,m=(i,t)=>{for(var e in t||(t={}))E.call(t,e)&&D(i,e,t[e]);if(P)for(var e of P(t))W.call(t,e)&&D(i,e,t[e]);return i},y=(i,t)=>R(i,I(t));var $=(i,t)=>{for(var e in t)w(i,e,{get:t[e],enumerable:!0})},_=(i,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of A(t))!E.call(i,s)&&s!==e&&w(i,s,{get:()=>t[s],enumerable:!(n=H(t,s))||n.enumerable});return i};var j=i=>_(w({},"__esModule",{value:!0}),i);var a=(i,t,e)=>new Promise((n,s)=>{var r=d=>{try{l(e.next(d))}catch(p){s(p)}},o=d=>{try{l(e.throw(d))}catch(p){s(p)}},l=d=>d.done?n(d.value):Promise.resolve(d.value).then(r,o);l((e=e.apply(i,t)).next())});var J={};$(J,{default:()=>b});module.exports=j(J);var V=require("obsidian");var u=require("obsidian");var v=class extends u.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}isExplicitlyExcluded(t){return this.plugin.settings.excludedFolders.includes(t)}isParentExcluded(t){return this.plugin.settings.excludedFolders.some(e=>t!==e&&t.startsWith(e+"/"))}toggleFolder(t,e){return a(this,null,function*(){let n=this.plugin.settings.excludedFolders.filter(s=>s!==t);e||(n.push(t),n=n.filter(s=>s===t||!s.startsWith(t+"/"))),this.plugin.settings.excludedFolders=n,this.plugin.data.settings.excludedFolders=n,yield this.plugin.persistPluginData(),yield this.plugin.refreshOpenView(),this.display()})}renderFolderTree(t,e,n){let s=t.children.filter(r=>r instanceof u.TFolder).sort((r,o)=>r.name.localeCompare(o.name));for(let r of s){let o=this.isExplicitlyExcluded(r.path),l=this.isParentExcluded(r.path),d=o||l,p=new u.Setting(e).setName(r.name).addToggle(c=>{c.setValue(!d),c.setDisabled(l),c.onChange(k=>a(this,null,function*(){yield this.toggleFolder(r.path,k)}))});p.settingEl.style.paddingLeft=`${n*20}px`,l&&(p.settingEl.style.opacity="0.4"),this.renderFolderTree(r,e,n+1)}}display(){let{containerEl:t}=this;t.empty(),new u.Setting(t).setName("\u6BCF\u6B21\u5C55\u793A\u7B14\u8BB0\u6570\u91CF").setDesc("\u4FA7\u8FB9\u680F\u4E2D\u540C\u65F6\u5C55\u793A\u7684\u7B14\u8BB0\u6570\u91CF\uFF083-10\uFF09").addSlider(s=>{s.setLimits(3,10,1).setValue(this.plugin.settings.noteCount).setDynamicTooltip().onChange(r=>a(this,null,function*(){this.plugin.settings.noteCount=r,this.plugin.data.settings.noteCount=r,yield this.plugin.persistPluginData(),yield this.plugin.refreshOpenView()}))}),t.createEl("h3",{text:"\u6392\u9664\u6587\u4EF6\u5939"}),t.createEl("p",{text:"\u5173\u95ED\u5F00\u5173\u4EE5\u6392\u9664\u8BE5\u6587\u4EF6\u5939\u4E2D\u7684\u7B14\u8BB0\u3002\u6392\u9664\u7236\u6587\u4EF6\u5939\u4F1A\u540C\u65F6\u6392\u9664\u6240\u6709\u5B50\u6587\u4EF6\u5939\u3002",cls:"setting-item-description"});let e=this.app.vault.getRoot();e.children.some(s=>s instanceof u.TFolder)?this.renderFolderTree(e,t,1):t.createEl("p",{text:"\u7B14\u8BB0\u5E93\u4E2D\u6682\u65E0\u6587\u4EF6\u5939\u3002",cls:"setting-item-description"}),new u.Setting(t).setName("\u6253\u5F00\u65F6\u81EA\u52A8\u5237\u65B0").setDesc("\u5F00\u542F\u540E\u6BCF\u6B21\u6253\u5F00\u4FA7\u8FB9\u680F\u4F1A\u81EA\u52A8\u6362\u4E00\u6279\u65B0\u7B14\u8BB0\uFF1B\u5173\u95ED\u5219\u4FDD\u7559\u4E0A\u6B21\u7684\u7B14\u8BB0").addToggle(s=>{s.setValue(this.plugin.settings.refreshOnOpen).onChange(r=>a(this,null,function*(){this.plugin.settings.refreshOnOpen=r,this.plugin.data.settings.refreshOnOpen=r,yield this.plugin.persistPluginData()}))})}};var M={noteCount:5,excludedFolders:[],refreshOnOpen:!0,onboardingDismissed:!1},h="mindspark-sidebar";function B(i){return y(m(m({},M),i!=null?i:{}),{excludedFolders:Array.isArray(i==null?void 0:i.excludedFolders)?i.excludedFolders:[]})}function K(i){if(!i||typeof i!="object")return{};let t={};for(let[e,n]of Object.entries(i)){if(!n||typeof n!="object")continue;let s=n,r=typeof s.lastShown=="number"?s.lastShown:0,o=typeof s.showCount=="number"?s.showCount:0;t[e]={lastShown:r,showCount:o}}return t}function T(i){return a(this,null,function*(){let t=yield i.loadData();return{settings:B(t==null?void 0:t.settings),viewHistory:K(t==null?void 0:t.viewHistory),lastShownPaths:Array.isArray(t==null?void 0:t.lastShownPaths)?t.lastShownPaths.filter(e=>typeof e=="string"):[]}})}function F(i,t){let e=i.viewHistory[t],n=e?e.showCount+1:1;return y(m({},i),{viewHistory:y(m({},i.viewHistory),{[t]:{lastShown:Date.now(),showCount:n}})})}var g=require("obsidian");function x(i){if(!i.startsWith("---"))return i;let t=i.split(/\r?\n/);if(t[0]!=="---")return i;for(let e=1;e<t.length;e+=1)if(t[e]==="---")return t.slice(e+1).join(`
`).trimStart();return i}function Y(i){if(!i.startsWith("---"))return null;let t=i.split(/\r?\n/);if(t[0]!=="---")return null;for(let e=1;e<t.length;e+=1){let n=t[e];if(n==="---")break;let s=n.match(/^title\s*:\s*(.+)$/i);if(s)return s[1].trim().replace(/^['\"]|['\"]$/g,"")||null}return null}function C(i){return i.replace(/```[\s\S]*?```/g," ").replace(/`([^`]+)`/g,"$1").replace(/!\[[^\]]*\]\([^)]*\)/g," ").replace(/\[([^\]]+)\]\([^)]*\)/g,"$1").replace(/^\s{0,3}#{1,6}\s+/gm,"").replace(/[*_~>#-]/g,"").replace(/\|/g," ").replace(/\s+/g," ").trim()}function N(i,t){let e=C(x(i));if(e.length===0){let n=x(i);return/```mermaid/i.test(n)?"(\u56FE\u8868\u7B14\u8BB0)":/```/.test(n)?"(\u4EE3\u7801\u7B14\u8BB0)":""}return e.length<=t?e:`${e.slice(0,t).trimEnd()}...`}function L(i,t){let e=Y(t);if(!e)return i.basename;let s=x(t).split(/\r?\n/).map(r=>C(r).trim()).find(r=>r.length>0);return s&&s===e?i.basename:e}function z(i,t){return Math.max((t-i)/(1e3*60*60),0)}function G(i,t){return Math.max((t-i)/(1e3*60*60*24),0)}function U(i,t,e){let n=1;if(!t||t.showCount===0)n*=3;else{let r=Math.min(z(t.lastShown,e)/72,1);n*=r}let s=1+Math.log2(G(i.stat.ctime,e)+1)*.1;return n*=s,Math.max(n,0)}function S(i,t){let e=t.map(n=>n.trim().replace(/\\/g,"/").replace(/^\/+|\/+$/g,"").toLowerCase()).filter(Boolean);return i.filter(n=>{if(n.extension!=="md")return!1;let s=n.path.replace(/\\/g,"/").toLowerCase();return!e.some(r=>s===r||s.startsWith(`${r}/`)||s.includes(`/${r}/`))})}function q(i,t,e){let n=i.map((o,l)=>({item:o,weight:Number.isFinite(t[l])?Math.max(t[l],0):0})),s=Math.min(Math.max(e,0),n.length),r=[];for(let o=0;o<s;o+=1){let l=n.reduce((c,k)=>c+k.weight,0);if(l<=0){r.push(n.shift().item);continue}let d=Math.random()*l,p=0;for(let c=0;c<n.length;c+=1)if(d-=n[c].weight,d<=0){p=c;break}r.push(n.splice(p,1)[0].item)}return r}function O(i,t,e,n){let s=S(i,e),r=Date.now(),o=s.map(l=>U(l,t[l.path],r));return q(s,o,n)}var f=class extends g.ItemView{constructor(e,n){super(e);this.noteContainerEl=null;this.currentNotes=[];this.plugin=n}getViewType(){return h}getDisplayText(){return"MindSpark"}getIcon(){return"dice"}onOpen(){return a(this,null,function*(){let e=this.containerEl.children[1];e.empty();let n=e.createDiv({cls:"mindspark-header"});n.createEl("h3",{text:"MindSpark"});let s=n.createEl("button",{cls:"clickable-icon",attr:{"aria-label":"\u5237\u65B0",type:"button"}});(0,g.setIcon)(s,"refresh-cw"),s.addEventListener("click",()=>{this.refreshNotes()}),this.plugin.settings.onboardingDismissed||this.renderOnboardingCard(e),this.noteContainerEl=e.createDiv({cls:"mindspark-notes"}),this.plugin.settings.refreshOnOpen?yield this.refreshNotes():yield this.restoreOrRefreshNotes()})}refreshNotes(){return a(this,null,function*(){if(!this.noteContainerEl)return;let e=this.plugin.app.vault.getMarkdownFiles(),n=S(e,this.plugin.settings.excludedFolders);if(this.noteContainerEl.empty(),e.length===0){this.currentNotes=[],this.renderEmptyState("\u7B14\u8BB0\u5E93\u4E2D\u8FD8\u6CA1\u6709\u7B14\u8BB0");return}if(n.length===0){this.currentNotes=[],this.renderEmptyState("\u6240\u6709\u7B14\u8BB0\u90FD\u88AB\u6392\u9664\u4E86\uFF0C\u8BF7\u68C0\u67E5\u8BBE\u7F6E");return}let s=O(e,this.plugin.data.viewHistory,this.plugin.settings.excludedFolders,this.plugin.settings.noteCount);this.currentNotes=s,this.plugin.data.lastShownPaths=s.map(r=>r.path);for(let r of s)try{yield this.renderNoteCard(r,this.noteContainerEl),this.plugin.data=F(this.plugin.data,r.path)}catch(o){console.warn(`MindSpark: \u6E32\u67D3\u7B14\u8BB0\u5931\u8D25 "${r.path}"`,o)}yield this.plugin.persistPluginData()})}renderNoteCard(e,n){return a(this,null,function*(){let s=n.createDiv({cls:"mindspark-card"});s.setAttribute("tabindex","0");let r=yield this.plugin.app.vault.cachedRead(e),o=L(e,r),l=N(r,180);s.createDiv({cls:"mindspark-card-title",text:o}),s.createDiv({cls:"mindspark-card-preview",text:l||"(\u7A7A\u7B14\u8BB0)"});let d=()=>a(this,null,function*(){yield this.plugin.app.workspace.getLeaf(!1).openFile(e)});s.addEventListener("click",()=>{d()}),s.addEventListener("keydown",p=>{p.key==="Enter"&&(p.preventDefault(),d())})})}renderOnboardingCard(e){let n=e.createDiv({cls:"mindspark-onboarding"});n.createDiv({text:"MindSpark \u4F1A\u968F\u673A\u6D6E\u73B0\u4F60\u8FC7\u53BB\u7684\u7B14\u8BB0\uFF0C\u5E2E\u52A9\u4F60\u91CD\u65B0\u8FDE\u63A5\u65E7\u60F3\u6CD5\u3002"}),n.createEl("button",{text:"\u5DF2\u4E86\u89E3",attr:{type:"button"}}).addEventListener("click",()=>{this.plugin.settings.onboardingDismissed=!0,this.plugin.data.settings.onboardingDismissed=!0,this.plugin.persistPluginData(),n.remove()})}renderEmptyState(e){this.noteContainerEl&&this.noteContainerEl.createDiv({cls:"mindspark-empty",text:e})}onClose(){return a(this,null,function*(){this.noteContainerEl=null})}restoreOrRefreshNotes(){return a(this,null,function*(){let e=this.plugin.data.lastShownPaths.map(n=>this.plugin.app.vault.getAbstractFileByPath(n)).filter(n=>n instanceof g.TFile);if(e.length===0){yield this.refreshNotes();return}this.currentNotes=e,yield this.renderCurrentNotes()})}renderCurrentNotes(){return a(this,null,function*(){if(!this.noteContainerEl)return;this.noteContainerEl.empty();let e=S(this.currentNotes,this.plugin.settings.excludedFolders);for(let n of e){let s=this.plugin.app.vault.getAbstractFileByPath(n.path);s instanceof g.TFile&&(yield this.renderNoteCard(s,this.noteContainerEl))}this.noteContainerEl.childElementCount===0&&(yield this.refreshNotes())})}};var b=class extends V.Plugin{onload(){return a(this,null,function*(){this.data=yield T(this),this.settings=this.data.settings,this.registerView(h,t=>new f(t,this)),this.addRibbonIcon("dice","MindSpark",()=>{this.activateView()}),this.addCommand({id:"open-sidebar",name:"\u6253\u5F00\u4FA7\u8FB9\u680F",callback:()=>{this.activateView()}}),this.addCommand({id:"refresh-notes",name:"\u5237\u65B0\u7B14\u8BB0",callback:()=>{this.refreshOpenView()}}),this.addSettingTab(new v(this.app,this))})}onunload(){return a(this,null,function*(){this.app.workspace.detachLeavesOfType(h)})}activateView(){return a(this,null,function*(){let t=this.app.workspace.getLeavesOfType(h)[0];if(t){this.app.workspace.revealLeaf(t);return}let e=this.app.workspace.getRightLeaf(!0);e&&(yield e.setViewState({type:h,active:!0}),this.app.workspace.revealLeaf(e))})}persistPluginData(){return a(this,null,function*(){this.data.settings=this.settings,yield this.saveData(this.data)})}refreshOpenView(){return a(this,null,function*(){let t=this.app.workspace.getLeavesOfType(h)[0];if(!t)return;let e=t.view;e instanceof f&&(yield e.refreshNotes())})}};
